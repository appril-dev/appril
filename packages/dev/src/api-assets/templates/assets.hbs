import type { Middleware } from "koa";
import { ZodNumber } from "zod";

{{#if importZodErrorHandlerFrom}}
import { zodErrorHandler } from "{{importZodErrorHandlerFrom}}";
{{else}}
import { fromZodError } from "zod-validation-error";
function zodErrorHandler(error: any) {
  return fromZodError(error, {
    prefix: null,
    issueSeparator: ";\n",
  })
};
{{/if}}

{{zodSchema}}

export default {
  paramsValidation: [
    (ctx, next) => {
      const shape: Record<string, unknown> = {{route.paramsTypeConst}}Schema.shape
      ctx.params = Object.entries(ctx.params).reduce((map: typeof ctx.params, [k,v]) => {
        map[k] = shape[k] instanceof ZodNumber && !/\D/.test(v as string) ? Number(v) : v
        return map
      }, {});
      try {
        {{route.paramsTypeConst}}Schema.parse(ctx.params)
      } catch (error: any) {
        throw zodErrorHandler(error)
      }
      return next()
    }
  ] satisfies Array<Middleware>,

  payloadValidation: {
    {{#if zodSchema}}
    {{#each payloadTypes}}
    {{index}}: [
      (ctx, next) => {
        try {
          {{id}}Schema.parse(ctx.payload)
        } catch (error: any) {
          throw zodErrorHandler(error)
        }
        return next()
      }
    ] satisfies Array<Middleware>,
    {{/each}}
    {{/if}}
  },
}

{{#if zodErrors.length}}
console.error("\n[ \x1b[31m{{route.file}}\x1b[0m ]: failed building zod schema(s)")
{{#each zodErrors}}
console.error(`{{this}}`)
{{/each}}
{{/if}}
