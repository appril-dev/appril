import {
  type MaybeRef,
  serialize, stringify,
} from "{{importPathFetch}}";

export type { MaybeRef };
export { fetch as fetchFactory } from "@appril/fetch";
export { baseurl, apiurl } from "{{importPathConfig}}";

export const fetchOptions = {
  ...serialize ? { serialize } : {},
  ...stringify ? { stringify } : {},
}

export function pathMaker(path: string, params: Array<unknown>): string {
  const values = [ ...params ]
  return path.split(/\/+/).flatMap((e) => {
    if (e.startsWith("[[") || e.startsWith("[...")) {
      // optional/rest param
      return values.splice(0)
    }
    if (e.startsWith("[")) {
      // required param
      return values.splice(0, 1)
    }
    return [ e ]
  }).join("/")
}

export function join(...args: Array<unknown>): string {
  return args
    .filter((e) => e)
    .join("/")
    .replace(/\/+/g, "/");
}

export async function withLoader(
  worker: () => Promise<any>,
  toggler?: (_s?: boolean) => boolean,
) {
  try {
    toggler?.(true)
    return await worker()
  }
  finally {
    toggler?.(false)
  }
}
