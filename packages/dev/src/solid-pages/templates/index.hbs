import {
  type HostOpt,
  createHost,
  stringify,
  join,
} from "@appril/api/lib";

import { baseurl } from "{{importPathmap.config}}";

export type LinkProps =
  {{#each pages}}
  | [ "{{originalPath}}", {{params.literal}} ]
  {{/each}}

export const resolvers = {
  {{#each pages}}
  "{{originalPath}}": () => {
    type ParamsT = [ {{params.literal}} ];
    type QueryT = Record<string, unknown>;

    const formatPath = (params: ParamsT) => [
{{#each params.tokens}}    "{{this}}",
{{/each}}
    ].reduce(
      (path, token, i) => path.replace(token, String(params[i] ?? "")),
      "{{originalPathParams}}"
    )

    const resolve = (
      params: ParamsT,
      query?: QueryT,
    ) => {
      const path = join(
        baseurl,
        formatPath(params),
      )
      return query
        ? [ path, stringify(query) ].join("?")
        : path;
    }

    return {
      formatPath,
      resolve,
      href: (
        host: HostOpt,
        params: ParamsT,
        query?: QueryT,
      ) => createHost(host) + resolve(params, query),
    }
  },
  {{/each}}
}

export const linkReplcements = {
{{#each pages}}
  "{{originalPath}}": resolvers["{{originalPath}}"]().formatPath,
{{/each}}
}

export default {
{{#each pages}}  "{{originalPath}}": resolvers["{{originalPath}}"](),
{{#each alias}}  "{{this}}": resolvers["{{../originalPath}}"](),
{{/each}}
{{/each}}
}
