import { type UseSpec, use } from "@appril/api";

{{#if importZodErrorHandlerFrom}}
import { zodErrorHandler } from "{{importZodErrorHandlerFrom}}";
{{else}}
import { fromZodError } from "zod-validation-error";
function zodErrorHandler(error: any) {
  return fromZodError(error, {
    prefix: null,
    issueSeparator: ";\n",
  })
};
{{/if}}

{{zodSchema}}

{{#if zodErrors.length}}
console.error("\n[ \x1b[31m{{route.file}}\x1b[0m ]: failed building zod schema(s)")
{{#each zodErrors}}
console.error(`{{this}}`)
{{/each}}
{{/if}}

const validateParams = () => [
  use<never, { params: Record<string, unknown> }>(
    (ctx, next) => {
      try {
        {{route.params.id}}Schema.parse(ctx.params)
      } catch (error: any) {
        throw zodErrorHandler(error)
      }
      return next()
    },
    { slot: "validate:params" },
  ) as unknown as UseSpec,
]

const validatePayload = () => [
  {{#if zodSchema}}
  {{#each payloadTypes}}
  use(
    (ctx, next) => {
      try {
        {{id}}Schema.parse(ctx.payload)
      } catch (error: any) {
        throw zodErrorHandler(error)
      }
      return next()
    },
    { slot: "validate:payload", before: "{{apiMethod}}" },
  ),
  {{/each}}
  {{/if}}
]

const validateResponse = () => [
  {{#if zodSchema}}
  {{#each returnTypes}}
  use(
    (ctx, next) => {
      try {
        {{id}}Schema.parse(ctx.body)
      } catch (error: any) {
        throw zodErrorHandler(error)
      }
      return next()
    },
    { slot: "validate:response", after: "{{apiMethod}}" },
  ),
  {{/each}}
  {{/if}}
]

export const paramsSchema = {{route.params.id}}Schema;

export const requestSchemas = {
{{#if zodSchema}}
{{#each payloadTypes}}
  {{httpMethod}}: {{id}}Schema,
{{/each}}
{{/if}}
}

export const responseSchemas = {
{{#if zodSchema}}
{{#each returnTypes}}
  {{httpMethod}}: {{id}}Schema,
{{/each}}
{{/if}}
}

export default () => [
  validateParams(),
  validatePayload(),
  validateResponse(),
].flat()
