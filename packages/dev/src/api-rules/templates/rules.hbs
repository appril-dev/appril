{{#if importZodErrorHandlerFrom}}
import { zodErrorHandler } from "{{importZodErrorHandlerFrom}}";
{{else}}
import { fromZodError } from "zod-validation-error";
function zodErrorHandler(error: any) {
  return fromZodError(error, { prefix: null, issueSeparator: ";\n" })
};
{{/if}}

{{zodSchema}}

{{#if zodErrors.length}}
console.error("\n[ \x1b[31m{{route.file}}\x1b[0m ]: failed building zod schema(s)")
{{#each zodErrors}}
console.error(`{{this}}`)
{{/each}}
{{/if}}

const validateParams = (
  ctx: import("@appril/api").ParameterizedContext,
) => {
  try {
    {{route.params.id}}Schema.parse(ctx.params)
  } catch (error: any) {
    throw zodErrorHandler(error)
  }
}

const validatePayload = {
  {{#if zodSchema}}
  {{#each payloadTypes}}
  {{apiMethod}}(
    ctx: import("@appril/api").ParameterizedContext,
  ) {
    try {
      {{id}}Schema.parse(ctx.payload)
    } catch (error: any) {
      throw zodErrorHandler(error)
    }
  },
  {{/each}}
  {{/if}}
}

const validateResponse = {
  {{#if zodSchema}}
  {{#each returnTypes}}
  {{apiMethod}}(
    ctx: import("@appril/api").ParameterizedContext,
  ) {
    try {
      {{id}}Schema.parse(ctx.body)
    } catch (error: any) {
      throw zodErrorHandler(error)
    }
  },
  {{/each}}
  {{/if}}
}

const paramsSchema = {{route.params.id}}Schema;

const payloadSchemas = {
{{#if zodSchema}}
{{#each payloadTypes}}
  {{httpMethod}}: {{id}}Schema,
{{/each}}
{{/if}}
}

const responseSchemas = {
{{#if zodSchema}}
{{#each returnTypes}}
  {{httpMethod}}: {{id}}Schema,
{{/each}}
{{/if}}
}

export default () => {
  return {
    params: validateParams,
    payload: validatePayload,
    response:  validateResponse,
    schemas: {
      params: paramsSchema,
      payload: payloadSchemas,
      response: responseSchemas,
    }
  }
}
