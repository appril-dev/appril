import { join } from "node:path";

import { type Meta, type RouteEndpoint, use, routeMapper } from "@appril/api/router";

import { baseurl, apiurl } from "{{importPathmap.config}}";
import { paramsHandlers, payloadHandlers } from "{{importPathmap.lib}}/base";
import router from "{{importPathmap.api}}/router";

{{#each routes}}
import {{importName}} from "{{../importPathmap.api}}/{{importPath}}";
{{#unless optedFile}}
import {{importName}}_assets from "{{../importPathmap.lib}}/{{importPath}}/_assets";
{{/unless}}
{{/each}}

export type ApiRoute ={{#each routes}}  {{#unless @first}}| {{/unless}}"{{originalPath}}"
{{/each}}

export const routeStack: Array<{
  path: string;
  originalPath: string;
  file: string;
  endpoints: Array<RouteEndpoint>;
  meta?: Meta;
}> = []

{{#each routes}}
routeStack.push({
  path: join(
    baseurl,
    {{#if base}}"{{base}}"{{else}}apiurl{{/if}},
    "{{path}}"
  ),
  originalPath: "{{originalPath}}",
  file: "{{file}}",
  endpoints: routeMapper([
    {{#unless optedFile}}
    use(paramsHandlers({{params.schema}})),
    use({{importName}}_assets.paramsValidation),
    use(payloadHandlers()),
    ...{{importName}}_assets.payloadValidation.map(([m,h]) => use(h).before(m)),
    {{/unless}}
    ...{{importName}},
  ] as Array<never>),
  {{#if meta}}
  meta: {{meta}},
  {{/if}}
})

{{/each}}

for (const { path, originalPath, endpoints } of routeStack) {
  for (const { method, middleware } of endpoints) {
    router.register(
      path.replace(/\+/g, "\\+"),
      [method],
      middleware as Array<never>,
      { name: originalPath },
    );
  }
}

export default router.routes();
