import { routeMiddlewareMapper } from "@appril/api/lib";

import tableInit from "{{importPathmap.table}}";
import { paramsSchema, useGlobalSpecs } from "..";

import crudFactory from "{{importPathmap.libCrud}}";
import type { InsertT, ListResponse, CreateResponse } from "./typeLiterals";

export { head, options, patch, put, del } from "@appril/api";
export * from "./typeLiterals";

export const columns = [
{{#each table.columns}}  "{{name}}",
{{/each}}
] as const;

export type ColumnT =
{{#each table.columns}}  | "{{name}}"
{{/each}};

export const {
  useWrapper,
  createWrapper,
  updateWrapper,
  deleteWrapper,
  retrieveWrapper,
  listWrapper,
} = crudFactory<
  "{{table.moduleName}}",
  ColumnT
>(
  tableInit(),
  columns,
  {
    primaryKey: "{{table.primaryKey}}",
  },
)

type ParamsT = {}

export const use = useWrapper<ParamsT>()

export const get = listWrapper<
  ParamsT,
  () => Promise<ListResponse>
>()

export const post = createWrapper<
  ParamsT,
  (payload: InsertT) => Promise<CreateResponse>
>()

export default (
  factory: (a: {
    use: typeof use;
    get: typeof get;
    post: typeof post;
  }) => Array<any>
) => routeMiddlewareMapper("{{route.file}}", {
  paramsSchema,
  factorySpecs: factory({ use, get, post }),
  useGlobalSpecs: useGlobalSpecs(),
});
